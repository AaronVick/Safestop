{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/disagreeable-automation.v1.2.json",
  "title": "Disagreeable Automation Artifacts v1.2",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "mode",
    "deployable",
    "authority_boundary",
    "ambiguity_handling",
    "contest_path",
    "reversibility_plan",
    "decision_receipt",
    "ownership_and_escalation"
  ],
  "properties": {
    "version": { "type": "string", "const": "1.2" },

    "mode": { "type": "string", "enum": ["standard", "builder", "chief_of_staff"] },

    "deployable": {
      "type": "boolean",
      "description": "True only if the workflow can be explained, challenged, and reversed/stopped in practice."
    },

    "missing_requirements": {
      "type": "array",
      "items": { "type": "string", "minLength": 3 },
      "description": "Required when deployable=false; list exactly what is missing."
    },

    "lifecycle": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional fields to keep artifacts living and reviewable over time.",
      "required": ["last_reviewed_date"],
      "properties": {
        "last_reviewed_date": { "type": "string", "format": "date" },
        "known_gaps": { "type": "array", "items": { "type": "string", "minLength": 3 } },
        "incident_triggers_for_re_review": {
          "type": "array",
          "description": "Events that force re-evaluation (e.g., incident severity, threshold breach).",
          "items": { "type": "string", "minLength": 3 }
        },
        "artifact_owner": { "type": "string", "minLength": 3 }
      }
    },

    "regulatory_alignment": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional mapping for governance and compliance programs.",
      "properties": {
        "regulatory_category": { "type": "string", "minLength": 3 },
        "compliance_frameworks": {
          "type": "array",
          "items": { "type": "string", "minLength": 3 }
        },
        "required_documentation": {
          "type": "array",
          "items": { "type": "string", "minLength": 3 }
        }
      }
    },

    "workflow_dependencies": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional: represent cross-workflow dependencies and cascade behavior in multi-agent systems.",
      "properties": {
        "upstream_dependencies": {
          "type": "array",
          "items": { "type": "string", "minLength": 3 }
        },
        "downstream_impacts": {
          "type": "array",
          "items": { "type": "string", "minLength": 3 }
        },
        "cascade_behavior": {
          "type": "string",
          "minLength": 10,
          "description": "What happens if upstream is contested/reversed (e.g., halt downstream, compensate, re-run)."
        }
      }
    },

    "authority_boundary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "scope",
        "allowed_actions",
        "forbidden_actions",
        "maximum_impact",
        "escalation_trigger",
        "quantified_limits"
      ],
      "properties": {
        "scope": { "type": "string", "minLength": 10 },

        "allowed_actions": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 3 }
        },

        "forbidden_actions": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 3 }
        },

        "maximum_impact": {
          "type": "string",
          "minLength": 5,
          "description": "Human-readable summary of the largest action allowed without escalation."
        },

        "escalation_trigger": { "type": "string", "minLength": 5 },

        "quantified_limits": {
          "type": "object",
          "additionalProperties": false,
          "description": "Machine-checkable thresholds and blast-radius limits.",
          "properties": {
            "money_limit": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "currency": { "type": "string", "minLength": 3 },
                "amount": { "type": "number", "minimum": 0 }
              },
              "required": ["currency", "amount"]
            },
            "record_limit": {
              "type": "integer",
              "minimum": 0,
              "description": "Max number of records/entities affected in a single run without escalation."
            },
            "time_window_seconds": {
              "type": "integer",
              "minimum": 0,
              "description": "Optional: limit applied per time window (e.g., per hour/day)."
            },
            "data_sensitivity": {
              "type": "string",
              "enum": ["public", "internal", "confidential", "restricted"],
              "description": "Highest data sensitivity level the workflow is allowed to touch without escalation."
            },
            "system_scope": {
              "type": "array",
              "description": "Systems the agent is allowed to act within (names/identifiers).",
              "items": { "type": "string", "minLength": 2 }
            },
            "blast_radius_metric": {
              "type": "string",
              "minLength": 3,
              "description": "How impact is measured for enforcement (e.g., 'downstream_api_calls', 'affected_user_accounts', 'modified_db_rows')."
            }
          },
          "required": ["record_limit", "data_sensitivity", "blast_radius_metric"]
        }
      }
    },

    "ambiguity_handling": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "what_counts_as_ambiguous",
        "routing_choice",
        "why_this_placement",
        "what_happens_while_waiting"
      ],
      "properties": {
        "what_counts_as_ambiguous": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 5 }
        },

        "routing_choice": {
          "type": "string",
          "enum": [
            "tighten_rules",
            "request_more_evidence",
            "human_decision",
            "safe_defer",
            "human_now_then_learn_and_tighten"
          ]
        },

        "why_this_placement": { "type": "string", "minLength": 30 },

        "what_happens_while_waiting": { "type": "string", "minLength": 10 },

        "learning_plan": {
          "type": "object",
          "additionalProperties": false,
          "description": "Required when routing_choice=human_now_then_learn_and_tighten.",
          "required": ["pattern_to_capture", "rule_or_classifier_target", "review_cycle"],
          "properties": {
            "pattern_to_capture": { "type": "string", "minLength": 10 },
            "rule_or_classifier_target": { "type": "string", "minLength": 10 },
            "review_cycle": { "type": "string", "minLength": 3 }
          }
        }
      }
    },

    "contest_path": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "who_can_contest",
        "how_to_contest",
        "what_changes_the_result",
        "evidence_requirements",
        "time_to_response",
        "during_contest_behavior",
        "sla_consequences"
      ],
      "properties": {
        "who_can_contest": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 3 }
        },

        "how_to_contest": { "type": "string", "minLength": 10 },

        "what_changes_the_result": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 5 },
          "description": "Human-readable conditions that change the outcome."
        },

        "evidence_requirements": {
          "type": "array",
          "minItems": 1,
          "description": "Structured evidence types to enable machine-checkable contestation when possible.",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["document_upload", "human_attestation", "system_verification", "manual_review_required"]
              },
              "required_fields": {
                "type": "array",
                "items": { "type": "string", "minLength": 2 }
              },
              "from_role": { "type": "string", "minLength": 2 },
              "api_endpoint": { "type": "string", "minLength": 2 },
              "notes": { "type": "string", "minLength": 0 }
            }
          }
        },

        "time_to_response": {
          "type": "string",
          "minLength": 3,
          "description": "Target response time (e.g., '2 hours', '1 business day')."
        },

        "during_contest_behavior": {
          "type": "string",
          "enum": ["paused", "held_safe_mode", "partial_reversible", "continue_with_guardrails"]
        },

        "sla_consequences": {
          "type": "object",
          "additionalProperties": false,
          "required": ["on_breach", "escalate_to"],
          "properties": {
            "on_breach": {
              "type": "string",
              "enum": ["auto_reverse", "auto_pause", "escalate_only", "continue_with_guardrails"]
            },
            "escalate_to": { "type": "string", "minLength": 3 }
          }
        }
      }
    },

    "reversibility_plan": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "safe_stop",
        "commit_points",
        "undo_strategy",
        "runaway_guardrails",
        "human_stop_authority",
        "irreversible_actions",
        "partial_action_states"
      ],
      "properties": {
        "safe_stop": { "type": "string", "minLength": 10 },

        "commit_points": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "what_commits_here", "approval_required"],
            "properties": {
              "name": { "type": "string", "minLength": 3 },
              "what_commits_here": { "type": "string", "minLength": 10 },
              "approval_required": { "type": "boolean" }
            }
          }
        },

        "undo_strategy": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "details"],
          "properties": {
            "type": { "type": "string", "enum": ["direct_rollback", "compensation", "mixed"] },
            "details": { "type": "string", "minLength": 20 }
          }
        },

        "runaway_guardrails": {
          "type": "array",
          "minItems": 1,
          "description": "Prefer measurable guardrails where possible.",
          "items": {
            "oneOf": [
              { "type": "string", "minLength": 5 },
              {
                "type": "object",
                "additionalProperties": false,
                "required": ["type"],
                "properties": {
                  "type": {
                    "type": "string",
                    "enum": ["rate_limit", "budget_cap", "failure_threshold", "blast_radius_cap", "time_box"]
                  },
                  "max_actions_per_minute": { "type": "integer", "minimum": 0 },
                  "max_spend_per_day": { "type": "number", "minimum": 0 },
                  "max_consecutive_errors": { "type": "integer", "minimum": 0 },
                  "max_blast_radius": { "type": "integer", "minimum": 0 },
                  "max_runtime_seconds": { "type": "integer", "minimum": 0 },
                  "notes": { "type": "string", "minLength": 0 }
                }
              }
            ]
          }
        },

        "human_stop_authority": {
          "type": "object",
          "additionalProperties": false,
          "required": ["who", "how"],
          "properties": {
            "who": { "type": "string", "minLength": 3 },
            "how": { "type": "string", "minLength": 10 }
          }
        },

        "irreversible_actions": {
          "type": "array",
          "items": { "type": "string", "minLength": 3 }
        },

        "partial_action_states": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["state_name", "what_is_done", "what_is_reversible", "what_requires_compensation"],
            "properties": {
              "state_name": { "type": "string", "minLength": 3 },
              "what_is_done": { "type": "string", "minLength": 10 },
              "what_is_reversible": { "type": "string", "minLength": 5 },
              "what_requires_compensation": { "type": "string", "minLength": 5 }
            }
          }
        }
      }
    },

    "decision_receipt": {
      "type": "object",
      "additionalProperties": false,
      "required": ["plain_language", "machine_readable"],
      "properties": {
        "plain_language": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "what_happened",
            "why",
            "what_it_relied_on",
            "who_or_what_approved",
            "how_to_challenge",
            "how_to_undo_or_stop",
            "who_owns_outcome"
          ],
          "properties": {
            "what_happened": { "type": "string", "minLength": 10 },
            "why": { "type": "string", "minLength": 10 },
            "what_it_relied_on": { "type": "string", "minLength": 10 },
            "who_or_what_approved": { "type": "string", "minLength": 3 },
            "how_to_challenge": { "type": "string", "minLength": 10 },
            "how_to_undo_or_stop": { "type": "string", "minLength": 10 },
            "who_owns_outcome": { "type": "string", "minLength": 3 }
          }
        },

        "machine_readable": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "decision_id",
            "timestamp",
            "decision",
            "action",
            "reason_codes",
            "inputs_summary",
            "policy_reference",
            "approval",
            "contest_reference",
            "undo_reference",
            "owner_reference",
            "retention_policy",
            "discovery_api",
            "export_format"
          ],
          "properties": {
            "decision_id": { "type": "string", "minLength": 6 },
            "timestamp": { "type": "string", "format": "date-time" },
            "decision": { "type": "string", "minLength": 3 },
            "action": { "type": "string", "minLength": 3 },
            "reason_codes": {
              "type": "array",
              "minItems": 1,
              "items": { "type": "string", "minLength": 2 }
            },
            "inputs_summary": { "type": "string", "minLength": 10 },
            "policy_reference": { "type": "string", "minLength": 3 },

            "approval": {
              "type": "object",
              "additionalProperties": false,
              "required": ["type", "by"],
              "properties": {
                "type": {
                  "type": "string",
                  "enum": [
                    "rule_based",
                    "human_approved",
                    "human_rejected",
                    "not_required",
                    "auto_approved_with_conditions",
                    "time_based_approval",
                    "delegated_approval"
                  ]
                },
                "by": { "type": "string", "minLength": 2 },
                "conditions": { "type": "string", "minLength": 0 },
                "expires_at": { "type": "string", "format": "date-time" },
                "delegated_system": { "type": "string", "minLength": 0 }
              }
            },

            "contest_reference": { "type": "string", "minLength": 3 },
            "undo_reference": { "type": "string", "minLength": 3 },
            "owner_reference": { "type": "string", "minLength": 3 },

            "retention_policy": {
              "type": "object",
              "additionalProperties": false,
              "required": ["duration", "basis"],
              "properties": {
                "duration": { "type": "string", "minLength": 2, "description": "e.g., '90d', '7y'" },
                "basis": { "type": "string", "minLength": 3, "description": "e.g., 'policy', 'regulatory', 'contract'" }
              }
            },

            "discovery_api": {
              "type": "string",
              "minLength": 3,
              "description": "Where receipts can be queried (endpoint, table, index, or internal service name)."
            },

            "export_format": {
              "type": "string",
              "enum": ["jsonl", "csv", "parquet", "pdf_bundle", "custom"],
              "description": "Preferred bulk export format for audits."
            }
          }
        }
      }
    },

    "ownership_and_escalation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "accountable_owner",
        "escalation_rule",
        "on_call_expectation",
        "audit_cadence",
        "handoff_protocol"
      ],
      "properties": {
        "accountable_owner": { "type": "string", "minLength": 3 },

        "escalation_rule": { "type": "string", "minLength": 10 },

        "on_call_expectation": { "type": "string", "minLength": 10 },

        "audit_cadence": { "type": "string", "minLength": 3 },

        "handoff_protocol": {
          "type": "object",
          "additionalProperties": false,
          "required": ["rotation_model", "handoff_steps", "where_recorded"],
          "properties": {
            "rotation_model": { "type": "string", "minLength": 5 },
            "handoff_steps": {
              "type": "array",
              "minItems": 1,
              "items": { "type": "string", "minLength": 5 }
            },
            "where_recorded": { "type": "string", "minLength": 5 }
          }
        }
      }
    },

    "observability_and_feedback": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional: runtime instrumentation and feedback loops that keep governance real.",
      "required": ["signals", "dashboards_or_logs", "feedback_routes", "review_triggers"],
      "properties": {
        "signals": {
          "type": "array",
          "minItems": 3,
          "items": { "type": "string", "minLength": 5 }
        },
        "dashboards_or_logs": { "type": "string", "minLength": 10 },
        "feedback_routes": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 5 }
        },
        "review_triggers": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 5 }
        }
      }
    },

    "implementation_notes": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "inputs",
        "outputs",
        "where_approvals_live",
        "where_stop_and_undo_live",
        "runtime_receipt_fields",
        "expected_failure_modes",
        "required_tests",
        "simulation_strategy",
        "canary_criteria"
      ],
      "properties": {
        "inputs": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 3 } },
        "outputs": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 3 } },
        "where_approvals_live": { "type": "string", "minLength": 10 },
        "where_stop_and_undo_live": { "type": "string", "minLength": 10 },
        "runtime_receipt_fields": { "type": "array", "minItems": 3, "items": { "type": "string", "minLength": 3 } },
        "expected_failure_modes": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 5 } },
        "required_tests": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 5 },
          "description": "Scenarios that must pass before deployment."
        },
        "simulation_strategy": {
          "type": "string",
          "minLength": 10,
          "description": "How to validate reversibility without production impact."
        },
        "canary_criteria": {
          "type": "string",
          "minLength": 10,
          "description": "Conditions for gradual rollout / abort."
        }
      }
    },

    "executive_brief": {
      "type": "object",
      "additionalProperties": false,
      "required": ["decision", "top_risks", "must_be_true_before_scale", "required_signoffs"],
      "properties": {
        "decision": { "type": "string", "enum": ["pilot", "do_not_pilot", "needs_redesign"] },
        "top_risks": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 5 } },
        "must_be_true_before_scale": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 5 } },
        "required_signoffs": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 3 } }
      }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "deployable": { "const": false } } },
      "then": { "required": ["missing_requirements"] }
    },
    {
      "if": { "properties": { "mode": { "const": "builder" } } },
      "then": { "required": ["implementation_notes"] }
    },
    {
      "if": { "properties": { "mode": { "const": "chief_of_staff" } } },
      "then": { "required": ["executive_brief"] }
    },
    {
      "if": {
        "properties": {
          "ambiguity_handling": {
            "properties": { "routing_choice": { "const": "human_now_then_learn_and_tighten" } }
          }
        }
      },
      "then": {
        "properties": { "ambiguity_handling": { "required": ["learning_plan"] } }
      }
    }
  ]
}
